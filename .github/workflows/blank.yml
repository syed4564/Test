name: Install RustDesk and Retrieve Remote ID

on:
  workflow_dispatch:

jobs:
  rustdesk_installation:
    runs-on: windows-latest

    steps:
      - name: Install RustDesk and Retrieve Remote ID
        run: |
          # PowerShell Script to download and install RustDesk
          $rustdesk_url = "https://github.com/rustdesk/rustdesk/releases/download/1.4.5/rustdesk-1.4.5-x86_64.exe"
          $download_path = "$env:TEMP\rustdesk-1.4.5-x86_64.exe"
          Invoke-WebRequest -Uri $rustdesk_url -OutFile $download_path
          Start-Process -FilePath $download_path -ArgumentList "/S" -Wait
          Write-Output "✅ RustDesk installed successfully."
          
          # Run RustDesk in background mode
          Start-Process -FilePath "C:\Program Files\RustDesk\rustdesk.exe" -ArgumentList "--no-ui" -Wait
          Write-Output "✅ RustDesk launched silently."

          # Extract remote ID and password from RustDesk log
          $log_file_path = "$env:APPDATA\RustDesk\rustdesk.log"
          $log_content = Get-Content -Path $log_file_path -Raw

          # Regular Expressions to extract remote ID and password
          $remote_id_pattern = "Remote ID: (\d+)"
          $password_pattern = "Password: (\d+)"

          $remote_id = [regex]::Match($log_content, $remote_id_pattern).Groups[1].Value
          $password = [regex]::Match($log_content, $password_pattern).Groups[1].Value

          if ($remote_id -and $password) {
              Write-Output "✅ Remote ID: $remote_id"
              Write-Output "✅ One-Time Password: $password"
          } else {
              Write-Output "❌ Failed to extract Remote ID or Password from the log file."
          }

          # Set GitHub Action outputs
          echo "::set-output name=remote_id::$remote_id"
          echo "::set-output name=password::$password"
