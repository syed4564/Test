name: Remote Desktop Colab 3
on:  
  workflow_dispatch:
    inputs:
      remote_code:
        description: 'Enter Chrome Remote Desktop Code'
        required: true
        type: string

jobs:
  build:
    name: Start RDP with Software, VPN, Audio, and Loop
    runs-on: windows-latest
    steps:
      - name: Install Chrome Remote Desktop Host
        run: |
          $msiUrl = "https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi"
          $msiPath = "$env:TEMP\chromeremotedesktophost.msi"
          Invoke-WebRequest -Uri $msiUrl -OutFile $msiPath
          Start-Process msiexec.exe -ArgumentList "/i `"$msiPath`" /qn" -Wait

      - name: Start Chrome Remote Desktop Session
        run: |
          $code = "${{ github.event.inputs.remote_code }}"
          $redirect = "https://remotedesktop.google.com/_/oauthredirect"
          $exePath = "${env:ProgramFiles(x86)}\Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe"
          Start-Process -FilePath "$exePath" -ArgumentList "--code=$code --redirect-url=$redirect --name=$env:COMPUTERNAME --pin=123456" -Wait

      - name: Fast Software Install (Discord Canary + WinRAR)
        run: |
          # Discord Canary works better in server environments/RDP
          choco install discord-canary winrar -y --no-progress
          Write-Output "âœ… Discord Canary and WinRAR installed."

      - name: Install IDM and Tor Browser
        run: |
          # IDM
          Invoke-WebRequest -Uri "https://mirror2.internetdownloadmanager.com/idman642build41.exe" -OutFile "$env:TEMP\idm_setup.exe"
          Start-Process -FilePath "$env:TEMP\idm_setup.exe" -ArgumentList "/skipdlgs" -Wait
          # Tor
          $extractPath = "$env:USERPROFILE\browser"
          Invoke-WebRequest -Uri "https://www.dropbox.com/scl/fi/faraacel5x4ssj5clo2j1/Browser.zip?rlkey=81rsd6nbwk2p95e0t3mpcirfi&st=3pnv7hia&dl=1" -OutFile "$env:TEMP\browser.zip"
          Expand-Archive -Path "$env:TEMP\browser.zip" -DestinationPath $extractPath -Force
          # Tor Shortcut
          $shell = New-Object -ComObject WScript.Shell
          $s = $shell.CreateShortcut("$env:USERPROFILE\Desktop\Tor.lnk")
          $s.TargetPath = "$extractPath\Browser\firefox.exe"
          $s.Save()

      - name: Install VPN Gate
        run: |
          $vpnURL = "https://www.dropbox.com/scl/fo/a6c0sqactnwr26cbbv1uc/APO1J80osQpo_8EoBOU3eJA?rlkey=s7wgg6ieuhlkr7wlxa9j9yij6&dl=1"
          Invoke-WebRequest -Uri $vpnURL -OutFile "$env:TEMP\vpn_bundle.zip"
          Expand-Archive -Path "$env:TEMP\vpn_bundle.zip" -DestinationPath "$env:USERPROFILE\Desktop\vpn_bundle" -Force
          Start-Process -FilePath "cmd.exe" -ArgumentList "/c install_vpngate.bat" -WorkingDirectory "$env:USERPROFILE\Desktop\vpn_bundle"

      - name: Install VB-CABLE Audio
        run: |
          Invoke-WebRequest -Uri "https://download.vb-audio.com/Download_CABLE/VBCABLE_Driver_Pack43.zip" -OutFile "$env:TEMP\VBCABLE.zip"
          Expand-Archive -Path "$env:TEMP\VBCABLE.zip" -DestinationPath "$env:TEMP\VBCABLE" -Force
          Start-Process -FilePath "$env:TEMP\VBCABLE\VBCABLE_Setup_x64.exe" -ArgumentList "-i -h"
          Start-Service "AudioSrv", "AudioEndpointBuilder"

      - name: Finalize Discord Launch (The "RDP Fix")
        run: |
          $appData = $env:LOCALAPPDATA
          # Find Discord Canary (usually more stable for this)
          $discordPath = Get-ChildItem -Path "$appData\DiscordCanary" -Filter "Discord.exe" -Recurse | Select-Object -First 1
          
          if ($discordPath) {
              # 1. Create a bulletproof Desktop Shortcut
              $shell = New-Object -ComObject WScript.Shell
              $shortcut = $shell.CreateShortcut("$env:USERPROFILE\Desktop\Discord.lnk")
              $shortcut.TargetPath = $discordPath.FullName
              $shortcut.WorkingDirectory = $discordPath.DirectoryName
              $shortcut.Save()

              # 2. Kill any ghost processes that might be blocking the UI
              taskkill /F /IM "DiscordCanary.exe" /T 2>$null
              
              # 3. Launch it properly so it shows up in your session
              Write-Output "ðŸš€ Forcing Discord to open..."
              Start-Process -FilePath $discordPath.FullName
          }

      - name: Clone Loop Repository and Run loop.bat
        run: |
          git clone https://github.com/Alex15969/Loop
          cd Loop
          cmd /c loop.bat
