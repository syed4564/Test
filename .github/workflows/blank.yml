name: Remote Desktop Colab 3

on:
  workflow_dispatch:
    inputs:
      remote_code:
        description: 'Enter Chrome Remote Desktop Code'
        required: true
        type: string

jobs:
  build:
    name: Start RDP with Software, VPN, Audio, and Loop
    runs-on: windows-latest

    steps:
      - name: Install Chrome Remote Desktop Host
        run: |
          $msiUrl = "https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi"
          $msiPath = "$env:TEMP\chromeremotedesktophost.msi"
          Invoke-WebRequest $msiUrl -OutFile $msiPath
          Start-Process msiexec.exe -ArgumentList "/i `"$msiPath`" /qn" -Wait

      - name: Start Chrome Remote Desktop Session
        run: |
          $code = "${{ github.event.inputs.remote_code }}"
          $exePath = "${env:ProgramFiles(x86)}\Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe"
          Start-Process $exePath "--code=$code --redirect-url=https://remotedesktop.google.com/_/oauthredirect --name=$env:COMPUTERNAME --pin=123456" -Wait

      # ==============================
      # SCREEN RESOLUTION
      # ==============================
      - name: Set Screen Resolution
        shell: cmd
        run: |
          curl -L -o "%TEMP%\nircmd.zip" https://www.nirsoft.net/utils/nircmd.zip
          powershell Expand-Archive "%TEMP%\nircmd.zip" "%TEMP%\nircmd" -Force
          "%TEMP%\nircmd\nircmd.exe" setdisplay 1366 768 32

      # ==============================
      # FORCE CHROME DEFAULT + DARK MODE + BLACK WALLPAPER
      # ==============================
      - name: Force Chrome Default + Dark Mode + Black Wallpaper
        run: |
          Write-Output "üåê Forcing Chrome as default browser..."

          $chrome = "${env:ProgramFiles}\Google\Chrome\Application\chrome.exe"

          if (Test-Path $chrome) {
              # Force default browser
              Start-Process $chrome "--make-default-browser"
          }

          # Force HTTP/HTTPS associations
          Set-ItemProperty "HKCU:\Software\Microsoft\Windows\Shell\Associations\UrlAssociations\http\UserChoice" ProgId ChromeHTML -ErrorAction SilentlyContinue
          Set-ItemProperty "HKCU:\Software\Microsoft\Windows\Shell\Associations\UrlAssociations\https\UserChoice" ProgId ChromeHTML -ErrorAction SilentlyContinue

          Write-Output "üåô Enabling Dark Mode (Apps + Taskbar)..."

          New-Item "HKCU:\Software\Microsoft\Windows\CurrentVersion\Themes\Personalize" -Force | Out-Null
          Set-ItemProperty "HKCU:\Software\Microsoft\Windows\CurrentVersion\Themes\Personalize" AppsUseLightTheme 0
          Set-ItemProperty "HKCU:\Software\Microsoft\Windows\CurrentVersion\Themes\Personalize" SystemUsesLightTheme 0

          Write-Output "üñ§ Applying solid black wallpaper..."

          Add-Type -AssemblyName System.Drawing
          $bmp = New-Object Drawing.Bitmap 1920,1080
          $g = [Drawing.Graphics]::FromImage($bmp)
          $g.Clear([Drawing.Color]::Black)
          $wall = "$env:TEMP\black.bmp"
          $bmp.Save($wall)

          Set-ItemProperty "HKCU:\Control Panel\Desktop" Wallpaper $wall
          Set-ItemProperty "HKCU:\Control Panel\Desktop" WallpaperStyle "2"
          Set-ItemProperty "HKCU:\Control Panel\Desktop" TileWallpaper "0"

          rundll32.exe user32.dll, UpdatePerUserSystemParameters
          Write-Output "‚úÖ Chrome forced default + Dark mode + Black wallpaper set."

      # ==============================
      # SOFTWARE INSTALLATION
      # ==============================
      - name: Install WinRAR & IDM
        run: |
          curl -L -o "$env:TEMP\winrar.exe" https://www.rarlab.com/rar/winrar-x64-712.exe
          Start-Process "$env:TEMP\winrar.exe" "/S" -Wait
          curl -L -o "$env:TEMP\idm.exe" https://mirror2.internetdownloadmanager.com/idman642build41.exe
          Start-Process "$env:TEMP\idm.exe" "/skipdlgs" -Wait

      - name: Set IDM Startup
        run: |
          $idm = "${env:ProgramFiles(x86)}\Internet Download Manager\IDMan.exe"
          Set-ItemProperty HKCU:\Software\Microsoft\Windows\CurrentVersion\Run IDMan "`"$idm`" /onstartup"
          Start-Process $idm

      - name: Install VPN Gate
        run: |
          curl -L -o "$env:TEMP\vpn.zip" https://www.dropbox.com/scl/fo/a6c0sqactnwr26cbbv1uc/APO1J80osQpo_8EoBOU3eJA?dl=1
          Expand-Archive "$env:TEMP\vpn.zip" "$env:USERPROFILE\Desktop\vpn" -Force
          Start-Process cmd.exe "/c install_vpngate.bat" -WorkingDirectory "$env:USERPROFILE\Desktop\vpn"

      - name: Install Discord (Silent)
        run: |
          curl -L -o "$env:TEMP\Discord.exe" https://discord.com/api/downloads/distributions/app/installers/latest?channel=stable&platform=win&arch=x64
          Start-Process "$env:TEMP\Discord.exe" "/S"

      - name: Create Discord & Tor Shortcuts
        run: |
          $shell = New-Object -ComObject WScript.Shell
          $d = $shell.CreateShortcut("$env:USERPROFILE\Desktop\Discord.lnk")
          $d.TargetPath = "$env:LOCALAPPDATA\Discord\Update.exe"
          $d.Arguments = "--processStart Discord.exe"
          $d.Save()

          curl -L -o "$env:TEMP\tor.zip" https://www.dropbox.com/scl/fi/faraacel5x4ssj5clo2j1/Browser.zip?dl=1
          Expand-Archive "$env:TEMP\tor.zip" "$env:USERPROFILE\browser" -Force
          $t = $shell.CreateShortcut("$env:USERPROFILE\Desktop\Tor.lnk")
          $t.TargetPath = "$env:USERPROFILE\browser\Browser\firefox.exe"
          $t.Save()

      - name: Install VB-CABLE Audio
        run: |
          curl -L -o "$env:TEMP\vbc.zip" https://download.vb-audio.com/Download_CABLE/VBCABLE_Driver_Pack43.zip
          Expand-Archive "$env:TEMP\vbc.zip" "$env:TEMP\vbc" -Force
          Start-Process "$env:TEMP\vbc\VBCABLE_Setup_x64.exe" "-i -h"
          Start-Service AudioSrv, AudioEndpointBuilder

      - name: Run Loop
        run: |
          git clone https://github.com/Alex15969/Loop
          cd Loop
          cmd /c loop.bat
