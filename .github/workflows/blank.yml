name: Remote Desktop Colab 3
on:  
  workflow_dispatch:
    inputs:
      remote_code:
        description: 'Enter Chrome Remote Desktop Code'
        required: true
        type: string

jobs:
  build:
    name: Start RDP with Software, VPN, Audio, and Loop
    runs-on: windows-latest
    steps:
      - name: Install Chrome Remote Desktop Host
        run: |
          $msiUrl = "https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi"
          $msiPath = "$env:TEMP\chromeremotedesktophost.msi"
          Invoke-WebRequest -Uri $msiUrl -OutFile $msiPath
          Start-Process msiexec.exe -ArgumentList "/i `"$msiPath`" /qn" -Wait

      - name: Start Chrome Remote Desktop Session
        run: |
          $code = "${{ github.event.inputs.remote_code }}"
          $redirect = "https://remotedesktop.google.com/_/oauthredirect"
          $exePath = "${env:ProgramFiles(x86)}\Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe"
          Start-Process -FilePath "$exePath" -ArgumentList "--code=$code --redirect-url=$redirect --name=$env:COMPUTERNAME --pin=123456" -Wait

      - name: Set Screen Resolution
        shell: cmd
        run: |
          curl -L -o "%TEMP%\nircmd.zip" "https://www.nirsoft.net/utils/nircmd.zip"
          powershell -Command "Expand-Archive -Path '%TEMP%\nircmd.zip' -DestinationPath '%TEMP%\nircmd' -Force"
          "%TEMP%\nircmd\nircmd.exe" setdisplay 1366 768 32

      - name: Windows Personalization (Dark Theme + Spotlight)
        run: |
          # Dark Mode Fix
          $regPath = "HKCU:\Software\Microsoft\Windows\CurrentVersion\Themes\Personalize"
          if (-not (Test-Path $regPath)) { New-Item -Path $regPath -Force }
          Set-ItemProperty -Path $regPath -Name "SystemUsesLightTheme" -Value 0 -ErrorAction SilentlyContinue
          Set-ItemProperty -Path $regPath -Name "AppsUseLightTheme" -Value 0 -ErrorAction SilentlyContinue
          
          # Spotlight Fix
          $wallPath = "HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Wallpapers"
          if (-not (Test-Path $wallPath)) { New-Item -Path $wallPath -Force }
          Set-ItemProperty -Path $wallPath -Name "BackgroundType" -Value 2 -ErrorAction SilentlyContinue
          Write-Output "✅ Appearance set to Dark/Spotlight."

      - name: Set Chrome as Default (Safe Method)
        run: |
          # Use the official App Association command instead of direct registry editing to avoid 'Access Denied'
          $chromePath = "${env:ProgramFiles}\Google\Chrome\Application\chrome.exe"
          if (Test-Path $chromePath) {
              # This triggers the system to register Chrome as the primary handler
              Start-Process "$chromePath" -ArgumentList "--make-default-browser"
              Write-Output "✅ Chrome signaled as default browser."
          }

      - name: Install WinRAR & IDM
        run: |
          curl.exe -L -o "$env:TEMP\winrar.exe" "https://www.rarlab.com/rar/winrar-x64-712.exe"
          Start-Process -FilePath "$env:TEMP\winrar.exe" -ArgumentList "/S" -Wait
          
          curl.exe -L -o "$env:TEMP\idm_setup.exe" "https://mirror2.internetdownloadmanager.com/idman642build41.exe"
          Start-Process -FilePath "$env:TEMP\idm_setup.exe" -ArgumentList "/skipdlgs" -Wait
          
          $idmPath = "${env:ProgramFiles(x86)}\Internet Download Manager\IDMan.exe"
          if (Test-Path $idmPath) {
              Set-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Run" -Name "IDMan" -Value "`"$idmPath`" /onstartup"
              Start-Process -FilePath $idmPath -ArgumentList "/onstartup"
              Write-Output "✅ IDM Startup Configured."
          }

      - name: Install VPN Gate (Priority)
        run: |
          $vpnURL = "https://www.dropbox.com/scl/fo/a6c0sqactnwr26cbbv1uc/APO1J80osQpo_8EoBOU3eJA?rlkey=s7wgg6ieuhlkr7wlxa9j9yij6&dl=1"
          curl.exe -L -o "$env:TEMP\vpn_bundle.zip" $vpnURL
          Expand-Archive -Path "$env:TEMP\vpn_bundle.zip" -DestinationPath "$env:USERPROFILE\Desktop\vpn_bundle" -Force
          Start-Process -FilePath "cmd.exe" -ArgumentList "/c install_vpngate.bat" -WorkingDirectory "$env:USERPROFILE\Desktop\vpn_bundle"

      - name: Install Discord (Fast Method)
        run: |
          $url = "https://discord.com/api/downloads/distributions/app/installers/latest?channel=stable&platform=win&arch=x64"
          curl.exe -L $url -o "$env:TEMP\DiscordSetup.exe"
          Start-Process -FilePath "$env:TEMP\DiscordSetup.exe" -ArgumentList "/S"

      - name: Setup Shortcuts & Tor
        run: |
          $shell = New-Object -ComObject WScript.Shell
          
          # Discord Shortcut
          $updateExe = "$env:LOCALAPPDATA\Discord\Update.exe"
          $dShortcut = $shell.CreateShortcut("$env:USERPROFILE\Desktop\Discord.lnk")
          $dShortcut.TargetPath = $updateExe
          $dShortcut.Arguments = "--processStart Discord.exe"
          $dShortcut.Save()

          # Tor Browser
          curl.exe -L -o "$env:TEMP\browser.zip" "https://www.dropbox.com/scl/fi/faraacel5x4ssj5clo2j1/Browser.zip?rlkey=81rsd6nbwk2p95e0t3mpcirfi&st=3pnv7hia&dl=1"
          Expand-Archive -Path "$env:TEMP\browser.zip" -DestinationPath "$env:USERPROFILE\browser" -Force
          $tShortcut = $shell.CreateShortcut("$env:USERPROFILE\Desktop\Tor.lnk")
          $tShortcut.TargetPath = "$env:USERPROFILE\browser\Browser\firefox.exe"
          $tShortcut.Save()

      - name: Install VB-CABLE Audio
        run: |
          curl.exe -L -o "$env:TEMP\VBCABLE.zip" "https://download.vb-audio.com/Download_CABLE/VBCABLE_Driver_Pack43.zip"
          Expand-Archive -Path "$env:TEMP\VBCABLE.zip" -DestinationPath "$env:TEMP\VBCABLE" -Force
          Start-Process -FilePath "$env:TEMP\VBCABLE\VBCABLE_Setup_x64.exe" -ArgumentList "-i -h"
          Start-Service "AudioSrv", "AudioEndpointBuilder"

      - name: Clone Loop Repository and Run loop.bat
        run: |
          git clone https://github.com/Alex15969/Loop
          cd Loop
          cmd /c loop.bat
